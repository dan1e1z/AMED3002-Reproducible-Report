---
title: "Assignment-2"
author: "Daniel Lindsay-Shad"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load-libraries}
library(tidyverse)
library(ggfortify)
library(ggplot2)
library(ggrepel)
library(RColorBrewer)
library(GEOquery)
library(org.Hs.eg.db)
library(limma)
library(edgeR)
library(Glimma)
library(ReactomePA)
library(clusterProfiler)
library(AnnotationDbi)
library(Homo.sapiens)
library(reactome.db)
library(ComplexHeatmap)
library(SummarizedExperiment)
library(gplots)
library(pheatmap)
```

```{r load-and-prepare-data}

# raw_patient_data <- read.delim("data/GSE256420_patients_norm_counts.txt", check.names = FALSE)
# additional_raw_patient_data <- read.delim("data/GSE256420_additional_patients_norm_counts.txt", check.names = FALSE)

raw_patient_data <- read.delim("data/GSE256420_patients_raw_counts.txt", check.names = FALSE)
additional_raw_patient_data <- read.delim("data/GSE256420_additional_patients_raw_counts.txt", check.names = FALSE)
additional_raw_patient_sample_data <- additional_raw_patient_data[,-c(2:3)]

combined_raw_patient_data <- merge(
  raw_patient_data,
  additional_raw_patient_sample_data,
  by = "Gene_ID"
)

counts <- as.matrix(combined_raw_patient_data[, -(1:3)])
genes <- data.frame(
  Gene_Name = combined_raw_patient_data$Gene_Name,
  Biotype = combined_raw_patient_data$Biotype,
  row.names = make.unique(combined_raw_patient_data$Gene_ID)
)

samples <- data.frame(
  group = factor(ifelse(grepl("^F", colnames(counts)), "F", "NF"), levels = c("NF", "F")),
  row.names = colnames(counts)
)

# unique(combined_raw_patient_data$Biotype)
lncRNA_data <- combined_raw_patient_data %>% filter(Biotype == "lncRNA")
protein_coding_data <- combined_raw_patient_data %>% filter(Biotype == "protein-coding")
```

```{r pathway-enrichment-preparation}
gene_entrez_ids <- clusterProfiler::bitr(
  combined_raw_patient_data$Gene_Name, 
  fromType = "SYMBOL", 
  toType = "ENTREZID", 
  OrgDb = org.Hs.eg.db
)

pathway_enrichment <- enrichPathway(
  gene = gene_entrez_ids$ENTREZID, 
  organism = "human"
)
```

```{r functions}
get_genes_counts_samples <- function(data) {
  genes <- data.frame (
    Gene_Name = data$Gene_Name,
    Biotype = data$Biotype,
    row.names = make.unique(data$Gene_ID)
  )
  counts <- as.matrix(data[, -(1:3)])
  samples <- data.frame(
    group = factor(ifelse(grepl("^F", colnames(counts)), "F", "NF"), levels = c("NF", "F")),
    row.names = colnames(counts)
  )
  return(list(genes = genes, counts = counts, samples = samples))
}

edger_dge_analysis <- function(genes, counts, samples) {
  dge <- DGEList(counts = counts, group = samples$group, genes = genes)
  dge <- dge[filterByExpr(dge), , keep.lib.sizes = FALSE]
  dge <- calcNormFactors(dge, method = "TMM")
  dge <- estimateDisp(dge)
  et <- exactTest(dge)
  results <- topTags(et, n = Inf)$table
  return(results)
}

get_pathway_specific_gene_dataset <- function(search, data) {
  pathway <- subset(pathway_enrichment@result, grepl(search, Description))
  gene_ids_list <- pathway$geneID
  gene_entrez_ids <- unlist(strsplit(gene_ids_list, split = "/"))
  gene_symbols <- clusterProfiler::bitr(
    gene_entrez_ids, 
    fromType = "ENTREZID", 
    toType = "SYMBOL", 
    OrgDb = org.Hs.eg.db
  )
  subset_data <- data %>% filter(Gene_Name %in% gene_symbols$SYMBOL)
  return(subset_data)
}

plot_pretty_volcano <- function(results, logFC_limit = 2.5, pval_threshold = 0.05, fc_threshold = 1.5, highlight_n = 20) {
  # Define significance based on P-value < 0.05 and absolute fold change >= 1.5
  results$Significance <- ifelse(results$logFC > 0 & results$PValue < pval_threshold & abs(results$logFC) >= log2(fc_threshold), "Up",
                                ifelse(results$logFC < 0 & results$PValue < pval_threshold & abs(results$logFC) >= log2(fc_threshold), "Down", "NS"))
  results$label <- ifelse(results$Significance != "NS", results$Gene_Name, NA)
  results <- results %>% mutate(rank = -log10(PValue)) %>%
    arrange(desc(rank)) %>%
    mutate(label = ifelse(row_number() <= highlight_n, label, NA))
  results$Shape <- ifelse(results$Significance == "Up", 16, ifelse(results$Significance == "Down", 17, 1))

  ggplot(results, aes(x = logFC, y = -log10(PValue))) +
    geom_point(aes(colour = Significance, shape = Significance), alpha = 0.7, size = 2) +
    geom_text_repel(aes(label = label), size = 3, max.overlaps = Inf, segment.curvature = 0, segment.color = NA) +
    scale_colour_manual(values = c("Up" = "red", "Down" = "blue", "NS" = "grey")) +
    scale_shape_manual(values = c("Up" = 16, "Down" = 17, "NS" = 1)) +
    geom_vline(xintercept = c(-log2(fc_threshold), log2(fc_threshold)), linetype = "dashed", colour = "black") +
    geom_hline(yintercept = -log10(pval_threshold), linetype = "dashed", colour = "black") +
    coord_cartesian(xlim = c(-logFC_limit, logFC_limit)) +
    theme_classic(base_size = 13) +
    theme(legend.position = "none") +
    labs(x = "Log2 Fold Change", y = "-log10 (P-value)")
}

create_pretty_volcano <- function(data) {
  res <- get_genes_counts_samples(data)
  results <- edger_dge_analysis(res$genes, res$counts, res$samples)
  plot_pretty_volcano(results)
}

create_pathway_specific_volcano <- function(search, data) {
  subset_data <- get_pathway_specific_gene_dataset(search, data)
  res <- get_genes_counts_samples(subset_data)
  results <- edger_dge_analysis(res$genes, res$counts, res$samples)
  plot_pretty_volcano(results)
}
```

```{r lncRNA-differential-expression-analysis}
lncRNA_counts <- lncRNA_data[, -(1:3)]
lncRNA_genes <- data.frame(
  Gene_ID = lncRNA_data$Gene_ID,
  Gene_Name = lncRNA_data$Gene_Name,
  Biotype = lncRNA_data$Biotype
)

# Create group factor
lncRNA_group <- factor(ifelse(grepl("^F", colnames(lncRNA_counts)), "F", "NF"), levels = c("NF", "F"))

# Create DGEList and perform differential expression analysis
lncRNA_dge <- DGEList(counts = lncRNA_counts, group = lncRNA_group, genes = lncRNA_genes)
lncRNA_dge <- lncRNA_dge[filterByExpr(lncRNA_dge), , keep.lib.sizes = FALSE]
lncRNA_dge <- calcNormFactors(lncRNA_dge)
lncRNA_dge <- estimateDisp(lncRNA_dge)
lncRNA_expression_test_results <- exactTest(lncRNA_dge)
lncRNA_results <- topTags(lncRNA_expression_test_results, n = Inf)$table

# Filter for significant genes (P < 0.05 and |FC| >= 1.5)
lncRNA_significant_genes_filter <- lncRNA_results$PValue < 0.05 & abs(lncRNA_results$logFC) >= log2(1.5)

# Get significant genes from the results table
significant_results <- lncRNA_results[lncRNA_significant_genes_filter, ]

# Get the gene names/IDs of significant genes
significant_gene_ids <- rownames(significant_results)

# Extract the significant genes from the original filtered DGE object
lncRNA_filtered_dge <- lncRNA_dge[rownames(lncRNA_dge) %in% significant_gene_ids, ]
```

```{r pca}
lcpm <- cpm(lncRNA_filtered_dge, log = TRUE, prior.count = 1)
pca <- prcomp(t(lcpm), scale = TRUE)
sample_info <- data.frame(
  Sample = colnames(lcpm),
  Group = lncRNA_group
)
autoplot(pca, data = sample_info, colour = "Group") +
  theme_minimal()
```

```{r heatmap}
# Calculate log2(CPM) for significant genes
lcpm <- cpm(lncRNA_filtered_dge, log = TRUE, prior.count = 1)

# Create sample metadata
samples <- data.frame(
  sample_id = colnames(lcpm),
  group = factor(ifelse(grepl("^F", colnames(lcpm)), "F", "NF"), levels = c("NF", "F"))
)
rownames(samples) <- samples$sample_id

# Manual ordering: NF samples first, then F samples
nf_samples <- rownames(samples)[samples$group == "NF"]
f_samples <- rownames(samples)[samples$group == "F"]
manual_order <- c(nf_samples, f_samples)

# Reorder data
lcpm <- lcpm[, manual_order]
samples <- samples[manual_order, , drop = FALSE]

# Z-score normalization by row (gene) to enhance clustering patterns
# This is crucial for getting the quadrant pattern
lcpm <- t(scale(t(lcpm)))

sample_annotation <- samples["group"]
rownames(sample_annotation) <- rownames(samples)

annotation_colors <- list(Condition = c(NF = "#98cc32", F = "#000000"))
my_colors <- colorRampPalette(c("#6a3fff", "#FFFFFF", "#fc3e1c"))(100)

col_heatmap_annotation <- HeatmapAnnotation(
  Condition = sample_annotation$group,
  col = annotation_colors,
  show_annotation_name = TRUE,
  annotation_name_side = "right"
)

ht_opt$message = FALSE
Heatmap(
  lcpm,
  col = my_colors,
  cluster_rows = FALSE,
  cluster_columns = TRUE,
  show_row_names = FALSE,
  show_column_names = TRUE,
  top_annotation = col_heatmap_annotation,
  column_gap = unit(4, "mm"),
  column_split = c(rep("NF", 9), rep("F", 10)),
  heatmap_legend_param = list(
    at = range(lcpm, na.rm = TRUE),
    labels = c("DOWN", "UP"),
    title = "Expression",
    legend_height = unit(4, "cm"),
    direction = "vertical"
  ),
  use_raster = TRUE,
  clustering_method_rows = "ward.D2",
  clustering_method_columns = "complete",
  row_km = 2,
  row_title = NULL
)
```

```{r volcano}
volcano_data <- lncRNA_results %>%
  mutate(Significance = case_when(
    PValue < 0.05 & abs(logFC) >= log2(1.5) & logFC > 0 ~ "Upregulated",
    PValue < 0.05 & abs(logFC) >= log2(1.5) & logFC < 0 ~ "Downregulated",
    TRUE ~ "Not-Significant"
  ))


up_count <- sum(volcano_data$Significance == "Upregulated")
down_count <- sum(volcano_data$Significance == "Downregulated")

top_genes <- volcano_data %>%
  filter(Significance != "Not-Significant") %>%
  arrange(PValue) %>%
  head(15)

ggplot(volcano_data, aes(x = logFC, y = -log10(PValue))) +
  geom_point(aes(colour = Significance), alpha = 0.7, size = 2) +
  geom_text_repel(data = top_genes, aes(label = Gene_Name), size = 3, max.overlaps = Inf) +
  scale_colour_manual(values = c("Upregulated" = "red", "Downregulated" = "blue", "Not-Significant" = "grey")) +
  geom_vline(xintercept = c(-log2(1.5), log2(1.5)), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_classic(base_size = 13) +
  theme(
    legend.title = element_blank(),
    legend.position = "top",
    plot.margin = margin(10, 15, 10, 10)
  ) +
  labs(
      x = "Log2 FoldChange", 
      y = "-Log10 (P-value)"
      ) +
  coord_cartesian(xlim = c(-4.5, 4.5), ylim = c(0, 7)) +
  annotate("text",
           x = 4.2, y = 6.4,
           label = paste(up_count, "lncRNAs"),
           colour = "red", size = 4, hjust = 1) +
  annotate("text",
           x = -4.2, y = 6.4,
           label = paste(down_count, "lncRNAs"),
           colour = "blue", size = 4, hjust = 0)

```

```{r pathway-specific-volcano}
create_pathway_specific_volcano("TGFB", protein_coding_data)
create_pathway_specific_volcano("Extracellular matrix organization", protein_coding_data)
create_pathway_specific_volcano("Collagen formation|Collagen biosynthesis", protein_coding_data)
```