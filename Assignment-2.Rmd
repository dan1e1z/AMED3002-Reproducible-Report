---
title: "Assignment-2"
author: "Daniel Lindsay-Shad"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load-data}
library(tidyverse)
library(ggfortify)
library(ggplot2)
library(ggrepel)
library(RColorBrewer)

library(GEOquery)
library(org.Hs.eg.db)
library(limma)
library(edgeR)
library(Glimma)

# Reactome enrichment analysis
library(ReactomePA)
library(clusterProfiler)
library(AnnotationDbi)
library(Homo.sapiens)

# heatmap
library(ComplexHeatmap)


# test
library(reactome.db)


library(SummarizedExperiment)
library(gplots)

# heatmap
library(pheatmap)


# Read 
# raw_patient_data <- read.delim("data/GSE256420_patients_norm_counts.txt", check.names = FALSE)
# additional_raw_patient_data <- read.delim("data/GSE256420_additional_patients_norm_counts.txt", check.names = FALSE)

raw_patient_data <- read.delim("data/GSE256420_patients_raw_counts.txt", check.names = FALSE)
additional_raw_patient_data <- read.delim("data/GSE256420_additional_patients_raw_counts.txt", check.names = FALSE)

additional_raw_patient_sample_data <- additional_raw_patient_data[,-c(2:3)]

combined_raw_patient_data <- merge(
  raw_patient_data,
  additional_raw_patient_sample_data,
  by = "Gene_ID",
)


counts <- as.matrix(combined_raw_patient_data[, -(1:3)])

genes <- data.frame(
  Gene_Name = combined_raw_patient_data$Gene_Name,
  Biotype = combined_raw_patient_data$Biotype,
  row.names = make.unique(combined_raw_patient_data$Gene_ID)
)

# Sample metadata 
samples <- data.frame(
  group = factor(ifelse(grepl("^F", colnames(counts)), "F", "NF"), levels = c("NF", "F")),
  row.names = colnames(counts)
)
```

```{r  data-exploration}
unique(combined_raw_patient_data$Biotype)

lncRNA_data <- combined_raw_patient_data %>% filter(Biotype == "lncRNA")
protein_coding_data <- combined_raw_patient_data %>% filter(Biotype == "protein-coding")
```

## Data Exploration and Preprocessing
```{r}

dge_data <- DGEList(counts = counts, samples = samples, genes = genes)

dge_data <- calcNormFactors(dge_data, method = "TMM")

keep_genes <- filterByExpr(dge_data)

dge_data <- dge_data[keep_genes,]

cpm <- cpm(dge_data)

lcpm <- cpm(dge_data, log=TRUE)
```

```{r}
pca <- prcomp(t(lcpm), scale = TRUE)

autoplot(pca, data = samples, colour = "group")
```

```{r}
design <- model.matrix(~ group, samples)

voom_data <- voom(dge_data, design, plot=TRUE)

fit <- lmFit(voom_data, design)

efit <- eBayes(fit)
# colnames(fit$coefficients)

volcanoplot(efit, coef = "groupF", highlight = 20, names = efit$genes$Gene_Name)
```


```{r}
lncRNA_counts <- lncRNA_data[, -(1:3)]

lncRNA_genes <- data.frame(
  Gene_ID = lncRNA_data$Gene_ID,
  Gene_Name = lncRNA_data$Gene_Name,
  Biotype = lncRNA_data$Biotype
)

lncRNA_group <- factor(
  ifelse(grepl("^F", colnames(lncRNA_counts)), "F", "NF"),
  levels = c("NF", "F")
)

# DGEList Object
lncRNA_dge <- DGEList(counts = lncRNA_counts, group = lncRNA_group, genes = lncRNA_genes)

# Filter lowly expressed genes
keep_genes <- filterByExpr(lncRNA_dge)
lncRNA_dge <- lncRNA_dge[keep_genes, , keep.lib.sizes = FALSE]

# Normalise library sizes and estimate dispersion
lncRNA_dge <- calcNormFactors(lncRNA_dge)
lncRNA_dge <- estimateDisp(lncRNA_dge)

# Perform exact test for differential expression
lncRNA_expression_test_results <- exactTest(lncRNA_dge)

# Extract all DE results with gene info
lncRNA_results <- topTags(lncRNA_expression_test_results, n = Inf)$table

# Filter significant genes 
lncRNA_significant_genes_filter <- lncRNA_results$PValue < 0.05 & abs(lncRNA_results$logFC) >= log2(1.405)
lncRNA_significant_genes_differential_expression_results <- lncRNA_results[lncRNA_significant_genes_filter, ]
```

```{r heatmap}

lcpm <- cpm(lncRNA_dge, log = TRUE, prior.count = 1)

# Identify samples by group
group1_samples <- rownames(samples)[samples$group == "NF"]
group2_samples <- rownames(samples)[samples$group == "F"] 

manual_order <- c(group1_samples, group2_samples)

# Reorder lcpm and samples accordingly
lcpm <- lcpm[, manual_order]
samples <- samples[manual_order, , drop = FALSE]

# Prepare annotation for columns
sample_annotation <- samples["group"]
rownames(sample_annotation) <- rownames(samples)

annotation_colors <- list(Condition = c(NF = "#98cc32", F = "#000000"))

min_val <- min(lcpm, na.rm = TRUE)
max_val <- max(lcpm, na.rm = TRUE)
my_colors <- colorRampPalette(c("#6a3fff", "#FFFFFF", "#fc3e1c"))(100)

# Order rows by mean expression descending
# row_order <- order(rowMeans(lcpm))
# lcpm <- lcpm[row_order, ]


#column annotation
col_heatmap_annotation <- HeatmapAnnotation(
  Condition = sample_annotation$group,
  col = annotation_colors,
  show_annotation_name = TRUE,
  annotation_name_side = "right"
)

ht_opt$message = FALSE
Heatmap(
  lcpm,
  col = my_colors,
  cluster_rows = FALSE,
  cluster_columns = TRUE, 
  show_row_names = FALSE,
  show_column_names = TRUE,
  column_title = NULL,
  column_names_gp = gpar(fontsize = 8),
  top_annotation = col_heatmap_annotation,
  column_gap = unit(4, "mm"),
  column_split = c(rep("NF", 9), rep("F", 10)),
  heatmap_legend_param = list(
    at = c(min_val, max_val),
    labels = c("DOWN", "UP"),
    title = "Expression",
    legend_height = unit(4, "cm"),
    direction = "vertical"
  ),
  use_raster = TRUE,
)
```

```{r}
gene_entrez_ids <- clusterProfiler::bitr(
  combined_raw_patient_data$Gene_Name, 
  fromType = "SYMBOL", 
  toType = "ENTREZID", 
  OrgDb = org.Hs.eg.db
)

# Perform pathway enrichment analysis
pathway_enrichment <- enrichPathway(
  gene = gene_entrez_ids$ENTREZID, 
  organism = "human"
)

get_genes_counts_samples <- function(data) {
  # Create data frame for genes and counts
  genes <- data.frame (
    Gene_Name = data$Gene_Name,
    Biotype = data$Biotype,
    row.names = make.unique(data$Gene_ID)
  )
  
  counts <- as.matrix(data[, -(1:3)])

  samples <- data.frame(
    # group = factor(ifelse(grepl("^F", colnames(counts)), "F", "NF")),
      group = factor(ifelse(grepl("^F", colnames(counts)), "F", "NF"), levels = c("NF", "F")),
    row.names = colnames(counts)
  )
  
  return(list(genes = genes, counts = counts, samples = samples))
}

voom_dge_analysis <- function(genes, counts, samples) {
  # Create DGEList
  dge <- DGEList(counts = counts, samples = samples, genes = genes)
  
  # TMM Normalisation
  dge <- calcNormFactors(dge, method = "TMM")
  
  # Filter low-expression genes
  keep_genes <- filterByExpr(dge)
  dge <- dge[keep_genes, ]
  
  # Design matrix
  design <- model.matrix(~ group, data = samples)
  
  # Voom transformation
  v <- voom(dge, design)
  
  # Fit linear model and apply empirical Bayes moderation
  fit <- lmFit(v, design)
  fit <- eBayes(fit)
  
  return(fit)
}


get_pathway_specific_gene_dataset  <- function(search) {
  # Filter "search" related pathways using "Description" column
  pathway <- subset(pathway_enrichment@result, grepl(search, Description))
  
  # Extract gene IDs from "search" related pathways
  gene_ids_list <- pathway$geneID
  gene_entrez_ids <- unlist(strsplit(gene_ids_list, split = "/"))
  
  # Convert gene Entrez IDs back to Gene Symbols
  gene_symbols <- clusterProfiler::bitr(
    gene_entrez_ids, 
    fromType = "ENTREZID", 
    toType = "SYMBOL", 
    OrgDb = org.Hs.eg.db
  )
  
  # Subset combined data for TGF-Î² related genes 
  subset_data <- combined_raw_patient_data %>%
  filter(Gene_Name %in% gene_symbols$SYMBOL)
  
  return (subset_data)
  
}


plot_pretty_volcano <- function(fit, coef_name = "groupF", logFC_limit = 2.5, pval_threshold = 0.05, highlight_n = 20) {
  # Extract stats
  top <- topTable(fit, coef = coef_name, number = Inf, sort.by = "P")
  
  # Add significance and direction
  top$Significance <- ifelse(top$logFC > 0 & top$adj.P.Val < pval_threshold, "Up",
                       ifelse(top$logFC < 0 & top$adj.P.Val < pval_threshold, "Down", "NS"))
  
  # Base label: only significant
  top$label <- ifelse(top$Significance != "NS", top$Gene_Name, NA)
  
  # Highlight top N significant genes
  top <- top %>%
    mutate(rank = -log10(adj.P.Val)) %>%
    arrange(desc(rank)) %>%
    mutate(label = ifelse(row_number() <= highlight_n, label, NA))
  
  # Assign shapes
  top$Shape <- ifelse(top$Significance == "Up", 16, 
                      ifelse(top$Significance == "Down", 17, 1))  # 16 = circle, 17 = triangle, 1 = dot
  
  # Plot
  ggplot(top, aes(x = logFC, y = -log10(adj.P.Val))) +
  geom_point(aes(colour = Significance, shape = Significance), alpha = 0.7, size = 2) +
  geom_text_repel(aes(label = label), size = 3, max.overlaps = Inf, segment.curvature = 0, segment.color = NA) +
  scale_colour_manual(values = c("Up" = "red", "Down" = "blue", "NS" = "grey")) +
  scale_shape_manual(values = c("Up" = 16, "Down" = 17, "NS" = 1)) +
  geom_vline(xintercept = 0, linetype = "dashed", colour = "black") +
  coord_cartesian(xlim = c(-logFC_limit, logFC_limit), ylim = c(0, 4)) +
  scale_x_continuous(breaks = c(-2, 0, 2)) +
  theme_classic() +
  theme(legend.position = "none") +
  labs(x = "Log2 Fold Change", y = "-log10 Adjusted P-Value")

}



create_pathway_specific_volcano <- function(search)  {
  subset_data <- get_pathway_specific_gene_dataset(search)
  res <- get_genes_counts_samples(subset_data)
  fit <- voom_dge_analysis(res$genes, res$counts, res$samples)
  # volcanoplot(fit, coef = "groupNF", highlight = 20, names = fit$genes$Gene_Name)
  plot_pretty_volcano(fit, coef_name = "groupF")

}

create_pathway_specific_volcano("TGFB")
create_pathway_specific_volcano("Extracellular matrix organization")
create_pathway_specific_volcano("Collagen formation|Collagen biosynthesis")

```