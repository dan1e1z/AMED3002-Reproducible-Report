---
title: "Assignment-2"
author: "Daniel Lindsay-Shad"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load-libraries}
library(tidyverse)
library(ggfortify)
library(ggplot2)
library(ggrepel)
library(RColorBrewer)
library(GEOquery)
library(org.Hs.eg.db)
library(limma)
library(edgeR)
library(Glimma)
library(ReactomePA)
library(clusterProfiler)
library(AnnotationDbi)
library(Homo.sapiens)
library(reactome.db)
library(ComplexHeatmap)
library(SummarizedExperiment)
library(gplots)
library(pheatmap)
```

```{r load-and-prepare-data}

# raw_patient_data <- read.delim("data/GSE256420_patients_norm_counts.txt", check.names = FALSE)
# additional_raw_patient_data <- read.delim("data/GSE256420_additional_patients_norm_counts.txt", check.names = FALSE)

raw_patient_data <- read.delim("data/GSE256420_patients_raw_counts.txt", check.names = FALSE)
additional_raw_patient_data <- read.delim("data/GSE256420_additional_patients_raw_counts.txt", check.names = FALSE)
additional_raw_patient_sample_data <- additional_raw_patient_data[,-c(2:3)]

combined_raw_patient_data <- merge(
  raw_patient_data,
  additional_raw_patient_sample_data,
  by = "Gene_ID"
)

counts <- as.matrix(combined_raw_patient_data[, -(1:3)])
genes <- data.frame(
  Gene_Name = combined_raw_patient_data$Gene_Name,
  Biotype = combined_raw_patient_data$Biotype,
  row.names = make.unique(combined_raw_patient_data$Gene_ID)
)

samples <- data.frame(
  group = factor(ifelse(grepl("^F", colnames(counts)), "F", "NF"), levels = c("NF", "F")),
  row.names = colnames(counts)
)

# unique(combined_raw_patient_data$Biotype)
lncRNA_data <- combined_raw_patient_data %>% filter(Biotype == "lncRNA")
protein_coding_data <- combined_raw_patient_data %>% filter(Biotype == "protein-coding")
```

```{r pathway-enrichment-preparation}
gene_entrez_ids <- clusterProfiler::bitr(
  combined_raw_patient_data$Gene_Name, 
  fromType = "SYMBOL", 
  toType = "ENTREZID", 
  OrgDb = org.Hs.eg.db
)

pathway_enrichment <- enrichPathway(
  gene = gene_entrez_ids$ENTREZID, 
  organism = "human"
)
```

```{r functions}
get_genes_counts_samples <- function(data) {
  genes <- data.frame (
    Gene_Name = data$Gene_Name,
    Biotype = data$Biotype,
    row.names = make.unique(data$Gene_ID)
  )
  counts <- as.matrix(data[, -(1:3)])
  samples <- data.frame(
    group = factor(ifelse(grepl("^F", colnames(counts)), "F", "NF"), levels = c("NF", "F")),
    row.names = colnames(counts)
  )
  return(list(genes = genes, counts = counts, samples = samples))
}

voom_dge_analysis <- function(genes, counts, samples) {
  dge <- DGEList(counts = counts, samples = samples, genes = genes)
  dge <- calcNormFactors(dge, method = "TMM")
  keep_genes <- filterByExpr(dge)
  dge <- dge[keep_genes, ]
  design <- model.matrix(~ group, data = samples)
  v <- voom(dge, design)
  fit <- lmFit(v, design)
  fit <- eBayes(fit)
  return(fit)
}

get_pathway_specific_gene_dataset <- function(search, data) {
  pathway <- subset(pathway_enrichment@result, grepl(search, Description))
  gene_ids_list <- pathway$geneID
  gene_entrez_ids <- unlist(strsplit(gene_ids_list, split = "/"))
  gene_symbols <- clusterProfiler::bitr(
    gene_entrez_ids, 
    fromType = "ENTREZID", 
    toType = "SYMBOL", 
    OrgDb = org.Hs.eg.db
  )
  subset_data <- data %>% filter(Gene_Name %in% gene_symbols$SYMBOL)
  return(subset_data)
}

plot_pretty_volcano <- function(fit, coef_name = "groupF", logFC_limit = 2.5, pval_threshold = 0.05, highlight_n = 20) {
  top <- topTable(fit, coef = coef_name, number = Inf, sort.by = "P")
  top$Significance <- ifelse(top$logFC > 0 & top$adj.P.Val < pval_threshold, "Up",
                             ifelse(top$logFC < 0 & top$adj.P.Val < pval_threshold, "Down", "NS"))
  top$label <- ifelse(top$Significance != "NS", top$Gene_Name, NA)
  top <- top %>% mutate(rank = -log10(adj.P.Val)) %>%
    arrange(desc(rank)) %>%
    mutate(label = ifelse(row_number() <= highlight_n, label, NA))
  top$Shape <- ifelse(top$Significance == "Up", 16, ifelse(top$Significance == "Down", 17, 1))

  ggplot(top, aes(x = logFC, y = -log10(adj.P.Val))) +
    geom_point(aes(colour = Significance, shape = Significance), alpha = 0.7, size = 2) +
    geom_text_repel(aes(label = label), size = 3, max.overlaps = Inf, segment.curvature = 0, segment.color = NA) +
    scale_colour_manual(values = c("Up" = "red", "Down" = "blue", "NS" = "grey")) +
    scale_shape_manual(values = c("Up" = 16, "Down" = 17, "NS" = 1)) +
    geom_vline(xintercept = 0, linetype = "dashed", colour = "black") +
    coord_cartesian(xlim = c(-logFC_limit, logFC_limit), ylim = c(0, 4)) +
    theme_classic() +
    theme(legend.position = "none") +
    labs(x = "Log2 Fold Change", y = "-log10 Adjusted P-Value")
}

create_pretty_volcano <- function(data) {
  res <- get_genes_counts_samples(data)
  fit <- voom_dge_analysis(res$genes, res$counts, res$samples)
  plot_pretty_volcano(fit, coef_name = "groupF")
}

create_pathway_specific_volcano <- function(search, data) {
  subset_data <- get_pathway_specific_gene_dataset(search, data)
  res <- get_genes_counts_samples(subset_data)
  fit <- voom_dge_analysis(res$genes, res$counts, res$samples)
  plot_pretty_volcano(fit, coef_name = "groupF")
}
```

```{r lncRNA-differential-expression-analysis}
lncRNA_counts <- lncRNA_data[, -(1:3)]
lncRNA_genes <- data.frame(
  Gene_ID = lncRNA_data$Gene_ID,
  Gene_Name = lncRNA_data$Gene_Name,
  Biotype = lncRNA_data$Biotype
)
lncRNA_group <- factor(ifelse(grepl("^F", colnames(lncRNA_counts)), "F", "NF"), levels = c("NF", "F"))

lncRNA_dge <- DGEList(counts = lncRNA_counts, group = lncRNA_group, genes = lncRNA_genes)
lncRNA_dge <- lncRNA_dge[filterByExpr(lncRNA_dge), , keep.lib.sizes = FALSE]
lncRNA_dge <- calcNormFactors(lncRNA_dge)
lncRNA_dge <- estimateDisp(lncRNA_dge)

lncRNA_expression_test_results <- exactTest(lncRNA_dge)
lncRNA_results <- topTags(lncRNA_expression_test_results, n = Inf)$table
lncRNA_significant_genes_filter <- lncRNA_results$PValue < 0.05 & abs(lncRNA_results$logFC) >= log2(1.5)
lncRNA_significant_genes_differential_expression_results <- lncRNA_data[lncRNA_significant_genes_filter, ]

lncRNA_significant_counts <- lncRNA_significant_genes_differential_expression_results[, -(1:3)]
lncRNA_significant_genes <- data.frame(
  Gene_ID = lncRNA_data$Gene_ID,
  Gene_Name = lncRNA_data$Gene_Name,
  Biotype = lncRNA_data$Biotype
)
lncRNA_significant_group <- factor(ifelse(grepl("^F", colnames(lncRNA_counts)), "F", "NF"), levels = c("NF", "F"))

lncRNA_significant_dge <- DGEList(counts = lncRNA_counts, group = lncRNA_group, genes = lncRNA_genes)

```

```{r pca}
lcpm <- cpm(lncRNA_signficant_dge, log = TRUE, prior.count = 1)
pca <- prcomp(t(lcpm), scale = TRUE)
sample_info <- data.frame(
  Sample = colnames(lcpm),
  Group = lncRNA_group
)
autoplot(pca, data = sample_info, colour = "Group") +
  theme_minimal()
```

```{r heatmap}

lcpm <- cpm(lncRNA_significant_dge, log = TRUE, prior.count = 1)

manual_order <- c(
  rownames(samples)[samples$group == "NF"],
  rownames(samples)[samples$group == "F"]
)

lcpm <- lcpm[, manual_order]
samples <- samples[manual_order, , drop = FALSE]

sample_annotation <- samples["group"]
rownames(sample_annotation) <- rownames(samples)

annotation_colors <- list(Condition = c(NF = "#98cc32", F = "#000000"))
my_colors <- colorRampPalette(c("#6a3fff", "#FFFFFF", "#fc3e1c"))(100)

col_heatmap_annotation <- HeatmapAnnotation(
  Condition = sample_annotation$group,
  col = annotation_colors,
  show_annotation_name = TRUE,
  annotation_name_side = "right"
)

ht_opt$message = FALSE
Heatmap(
  lcpm,
  col = my_colors,
  cluster_rows = FALSE,
  cluster_columns = TRUE,
  show_row_names = FALSE,
  show_column_names = TRUE,
  top_annotation = col_heatmap_annotation,
  column_gap = unit(4, "mm"),
  column_split = c(rep("NF", 9), rep("F", 10)),
  heatmap_legend_param = list(
    at = range(lcpm, na.rm = TRUE),
    labels = c("DOWN", "UP"),
    title = "Expression",
    legend_height = unit(4, "cm"),
    direction = "vertical"
  ),
  use_raster = TRUE
)
```

```{r volcano}
volcano_data <- lncRNA_results %>%
  mutate(Significance = case_when(
    PValue < 0.05 & abs(logFC) >= log2(1.5) & logFC > 0 ~ "Up",
    PValue < 0.05 & abs(logFC) >= log2(1.5) & logFC < 0 ~ "Down",
    TRUE ~ "NS"
  ))


up_count <- sum(volcano_data$Significance == "Up")
down_count <- sum(volcano_data$Significance == "Down")

top_genes <- volcano_data %>%
  filter(Significance != "NS") %>%
  arrange(PValue) %>%
  head(15)

ggplot(volcano_data, aes(x = logFC, y = -log10(PValue))) +
  geom_point(aes(colour = Significance), alpha = 0.7, size = 2) +
  geom_text_repel(data = top_genes, aes(label = Gene_Name), size = 3, max.overlaps = Inf) +
  scale_colour_manual(values = c("Up" = "red", "Down" = "blue", "NS" = "grey")) +
  geom_vline(xintercept = c(-log2(1.5), log2(1.5)), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_classic() +
  labs(x = "Log2 FoldChange", y = "-Log10(P-value)") +
  
  annotate("text",
         x = 5,
         y = 7,
         label = paste("Upregulated:", up_count),
         hjust = 1, vjust = 1.5, colour = "red", size = 4) +

annotate("text",
         x = -5,
         y = 7,
         label = paste("Downregulated:", down_count),
         hjust = 0, vjust = 1.5, colour = "blue", size = 4)
```

```{r pathway-specific-volcano}
create_pathway_specific_volcano("TGFB", protein_coding_data)
create_pathway_specific_volcano("Extracellular matrix organization", protein_coding_data)
create_pathway_specific_volcano("Collagen formation|Collagen biosynthesis", protein_coding_data)
```